---
title: "Data Manipulation With Dplyr"
author: "Adejumo Ridwan Suleiman"
date: "`r Sys.Date()`"
output: html_document
---

# Installing dplyr
```{r}
#install.packages("dplyr")
library(dplyr)
```


# Installing nycflights13
This data is an RDMS: a Relational Database Management System, it is made up of more than one table of data which are related to each other.
- flights
- airlines
- airport
- planes
- weather

```{r}
#install.packages("nycflights13)
library(nycflights13)
```


## Flights (Main Data)
Details of all flights in the year 2013
```{r}
head(flights)
```


## Airlines Names
```{r}
head(airlines)
```

## Airport Metadata
```{r}
head(airports)
```

## Planes Metadata
```{r}
head(planes)
```

## Weather (hourly)
```{r}
head(weather)
?weather
```

# Grouping and Summarizing
Collapse Values in a dataset to a single summary
```{r}
# Average departure and arrival delay by month
head(flights)
avg_dep_arr_delay <- flights |> 
  group_by(year, month) |> 
  summarize(avg_departure_delay = mean(dep_delay, na.rm = TRUE),
            avg_arrival_delay = mean(arr_delay, na.rm = TRUE))
avg_dep_arr_delay
```

```{r}
# Carriers with most average delay
head(flights)
avg_carrier_delay <- flights |> 
  group_by(carrier) |> 
  summarize(avg_departure_delay = mean(dep_delay, na.rm = TRUE),
            avg_arrival_delay = mean(arr_delay, na.rm = TRUE))
avg_carrier_delay
```

# Arranging 
Reordering the rows of a dataset
```{r}
# Most Delayed Flight
flights |> 
  arrange(desc(dep_delay))
```

```{r}
# Flights that left the earliest
flights |> 
  arrange(arr_delay)
```

# Filtering
Pick observations by their values in a dataset

```{r}
# Check for the range of Arrival and departure delays
range(flights$arr_delay, na.rm = TRUE)
range(flights$dep_delay, na.rm = TRUE)

```

```{r}
# Check for flights with arrival and departuredelay above 1000
delay_arr_more_than_1000 <- flights |> 
  filter(arr_delay >= 1000 | dep_delay > 1000)
delay_morethan_1000
```


```{r}
# Flights with no delay
flights |> 
  filter(arr_delay == 0 & dep_delay == 0)
  
```


# Selecting
Select variables by their names
```{r}
# Select dep_time, dep_delay, arr_time, arr_delay
flights |> 
  select(dep_time, dep_delay, arr_time, arr_delay)
```

```{r}
# another way(select by their index numbers)
flights |> 
  select(4,6,7,9)
```

```{r}
# another way
flights |> 
  select(dep_time:arr_delay, -c(5,8))
```

```{r}
#select all variables except the arrival and departure delay
flights |> 
  select(!c(arr_delay, dep_delay))
```


## Selection Helpers
1. starts_with()
2. ends_with()
3. contains()


# Creating Variables
```{r}
#  Create New variable Speed
flights |> 
  mutate(speed = distance/air_time*60, .keep = "used") |> 
  arrange(speed)
```

```{r}
# Keep only speed variable
flights |> 
  transmute(speed = distance/air_time*60) |> 
  arrange(speed)
```

# Renaming 

```{r}
# rename dep_time to departure time
flights |> 
  rename(departure_time = dep_time)
```


# Mutating Joins
Mutating joins adds new variables to a data, from matching observations in another.
```{r}
#inner join
inner_join(x = avg_carrier_delay, 
           y = airlines, 
           by = "carrier") |> 
  arrange(desc(avg_departure_delay))
```

```{r}
#left join
left_join(x = delay_arr_more_than_1000, 
          y = airlines, 
          by = "carrier")

```

```{r}
#right join
right_join(x = airlines, 
           y = delay_arr_more_than_1000, 
           by = "carrier")
```

```{r}
#full join
full_join(x = delay_arr_more_than_1000, 
          y = airlines, 
          by = "carrier")
```


# Filtering Joins
Filtering joins filters matching observations, based on whether they match or not.
1. semi_join() Keeps all observations in X that have a match in y
2. anti_join() drops all observations in x that have a match in y

```{r}
# Top 10 most popular destination
top_dest <- flights %>%
  count(dest, sort = TRUE) %>%
  head(10)
top_dest
```

```{r}
# using semi join to filter it out from flights data
semi_join(x = flights, y = top_dest)
```

```{r}
anti_join(x = flights, 
          y = top_dest)
```

# Exercise

## Question 1
Using the flights data set, which carrier have the highest average speed.
Note: Remember to set na.rm = TRUE when calculating the average speed.
1. Hawaiian Airlines Inc. 
2. Virgin America
3. Alaska Airlines Inc.
4. Frontier Airlines Inc.
5. United Air Lines Inc.
```{r}
avg_speed_table <- flights |> 
  mutate(speed = distance/air_time*60) |> 
  group_by(carrier) |> 
  summarize(avg_speed = mean(speed, na.rm = TRUE)) |> 
  arrange(desc(avg_speed))

avg_speed_table

inner_join(x = avg_speed_table, 
           y = airlines, 
           by = "carrier")
```

## Question 2
How many flights in the month of December had no departure and  arrrival delay.
1.39
2.37
3.32
4.31
5.34
```{r}
flights |> 
  filter(arr_delay == 0 & dep_delay == 0 & month == 12)
```

## Question 3
What is the distance covered in Kilometers for the flight with id number 4646 and tailnum N273WN. Note: A mile is 1.6 Kilometers
1. 115.625 Kilometers
2. 296 Kilometers
3. 290 Kilometers
4. 78 Kilometers
5. 234 Kilometers
```{r}
flight_4646_N273WN <- flights |> 
  filter(flight == 4646 & tailnum == "N273WN") |> 
  mutate(dist_kil = distance*1.6)

flight_4646_N273WN
```

## Question 4
The manufacturer of the plane in Question 3 is:
1. SIKORSKY
2. EMBRAER
3. AIRBUS
4. BOEING
5. GULFSTREAM AEROSPACE
```{r}
inner_join(x = flight_4646_N273WN,
           y = planes, 
           by = "tailnum") |> 
  select(manufacturer)
```

